version: "3.7"

services:
  server:
    image: jiro4989/nimbot:server-runtime
    restart: on-failure
    environment: &app-env
      PORT: '4001'
      DB_HOST: mongodb
      DB_PORT: '27017'
      DB_DBNAME: nimbot
      DB_USER: writer
      DB_PASSWORD: "$DB_PASSWORD"
    ports:
      - 4001:4001
    depends_on:
      - executor
    logging: &logging
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "log.{{.Name}}"
    entrypoint: "/usr/local/bin/nimbot_server"

  executor:
    image: jiro4989/nimbot:executor-runtime
    restart: on-failure
    environment:
      <<: *app-env
      SLACK_URL: "$SLACK_URL"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock" # docker out of docker
    logging: *logging
    entrypoint: "/usr/local/bin/nimbot_executor"

  slack_mock:
    image: nginx:1.17
    expose:
      - "80"
      - "443"
    logging: *logging

networks:
  mongodb_default:
    external: true
  fluentd_default:
    external: true
